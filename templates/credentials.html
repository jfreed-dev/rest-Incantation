{% extends "base.html" %}

{% block title %}Configure Authentication - REST Incantation{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('index') }}" class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Home
        </a>
    </div>

    <h1 class="text-2xl font-bold text-gray-900 mb-2">Configure Authentication</h1>
    <p class="text-gray-600 mb-6">Enter the credentials required by this API.</p>

    <form method="post" action="{{ url_for('credentials') }}">
        {# Render auth-type-specific forms based on detected schemes #}
        {% if auth_schemes %}
            {% for name, scheme in auth_schemes.items() %}
                {% if scheme.scheme_type == 'apiKey' %}
                    {% include "components/auth_form_apikey.html" %}
                {% elif scheme.scheme_type == 'http' %}
                    {% if scheme.scheme == 'basic' %}
                        {% include "components/auth_form_basic.html" %}
                    {% elif scheme.scheme == 'bearer' %}
                        {% include "components/auth_form_bearer.html" %}
                    {% else %}
                        {% include "components/auth_form_bearer.html" %}
                    {% endif %}
                {% elif scheme.scheme_type == 'oauth2' %}
                    {% include "components/auth_form_oauth2.html" %}
                {% elif scheme.scheme_type == 'openIdConnect' %}
                    {% include "components/auth_form_oauth2.html" %}
                {% endif %}
            {% endfor %}
        {% elif auth_methods %}
            {# Fallback for simple auth_methods dict (backward compatibility) #}
            {% for method, type in auth_methods.items() %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">{{ method }}</h3>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if type == 'apiKey' %}bg-blue-100 text-blue-800
                        {% elif type == 'oauth2' %}bg-orange-100 text-orange-800
                        {% elif type == 'http' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ type }}
                    </span>
                </div>
                <div>
                    <label for="{{ method }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {% if type == 'apiKey' %}API Key
                        {% elif type == 'oauth2' %}OAuth Token
                        {% elif type == 'http' %}HTTP Auth Value
                        {% else %}Credential Value{% endif %}
                    </label>
                    <input type="password"
                           id="{{ method }}"
                           name="{{ method }}"
                           placeholder="{% if type == 'apiKey' %}Enter API Key{% elif type == 'oauth2' %}Enter OAuth Token{% elif type == 'http' %}Enter HTTP auth value{% else %}Enter credential value{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex">
                    <svg class="h-5 w-5 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">No authentication schemes detected in this API specification.</p>
                    </div>
                </div>
            </div>
        {% endif %}

        {# Custom Headers Section #}
        {% include "components/custom_headers.html" %}

        {# Storage Preference #}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Storage Options</h3>
            <div class="space-y-3">
                <label class="flex items-start">
                    <input type="radio"
                           name="storage_preference"
                           value="session"
                           checked
                           class="mt-0.5 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                    <span class="ml-3">
                        <span class="block text-sm font-medium text-gray-700">Session only</span>
                        <span class="block text-sm text-gray-500">Credentials cleared when browser closes. More secure.</span>
                    </span>
                </label>
                <label class="flex items-start">
                    <input type="radio"
                           name="storage_preference"
                           value="file"
                           class="mt-0.5 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                    <span class="ml-3">
                        <span class="block text-sm font-medium text-gray-700">Persist to file</span>
                        <span class="block text-sm text-gray-500">Encrypted storage. Credentials survive restarts.</span>
                    </span>
                </label>
            </div>
        </div>

        {# Token Renewal Configuration #}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Token Renewal</h3>
            <div class="space-y-4">
                <label class="flex items-center">
                    <input type="checkbox"
                           name="enable_renewal"
                           id="enable_renewal"
                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Enable automatic token renewal</span>
                </label>
                <div class="flex items-center space-x-3">
                    <label for="renewal_interval" class="text-sm text-gray-700">Renewal interval:</label>
                    <input type="number"
                           id="renewal_interval"
                           name="renewal_interval"
                           value="15"
                           min="1"
                           max="1440"
                           class="w-20 px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <span class="text-sm text-gray-500">minutes</span>
                </div>
            </div>
        </div>

        {# Submit Button #}
        <button type="submit"
                class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Configure & Continue
        </button>
    </form>
</div>
{% endblock %}
